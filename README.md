# autosave_dag

Этот код — **автоматический скрипт, который**:
- Забирает файлы из системы управления проектами (AirTable)
- Сохраняет их на сетевой диск (Share) в папки конкретных проектов АЭС (КурАЭС-2, Аккую, Руппур и др.)
- Обновляет статус в системе, что файлы успешно сохранены
Работает по будням в 6:30 утра без участия человека.

<br>

# check_dbt

Этот код **один раз запускает SQL-модель в базе данных через инструмент dbt**.
dbt берёт SQL-запрос, выполняет его и сохраняет результат как таблицу. Здесь запускается конкретная модель my_first_dbt_model — обычно это тестовая или первая модель в проекте.

<br>

# com_dashboards

Этот код — **ежедневный отчёт для руководства**.
Собирает статистику по активным проектам из AirTable и PostgreSQL, считает:
- Типы проектов (инжиниринг, сопровождение, производство)
- Объекты поставки (АЭС Руппур, Аккую и др.)
- Заводы-изготовители
И отправляет всё в Google Таблицу (два листа — из AirTable, третий — из базы данных).
Запускается по будням в 20:00.

<br>

# icp_metrics_sheet

Этот код — **мониторинг качества данных для 7 заводов-изготовителей**.
Собирает метрики из базы данных:
- Изменения (shifts) — по каждому заводу отдельно
- Соответствие KKS и количества (kks_vs_qty)
- Заполненность полей (fill_percent)
- Корректность дат (date_correctness)
- Ошибки в типах дат (errors_in_date_type)
- Даты на 2 недели (two_weeks)
- Жёлтые даты (yellow_dates)
Отправляет всё в Google Таблицу на разные листы.
Запускается по будням каждые 2 часа с 6:30 до 15:30 (6:30, 8:30, 10:30, 12:30, 14:30).

<br>

# icp_metrics

Этот код — **разовая рассылка метрик по email**.
Делает два SQL-запроса к базе:
- KKS vs QTY — проверяет расхождение количества позиций и кодов KKS
- EMPTY COUNTER — считает пустые ячейки по колонкам
Формирует Excel-файл с двумя листами и отправляет на почту с HTML-описанием.
Запускается один раз 27 ноября 2025 в 4:00 (ручной запуск через Airflow).

<br>

# intermidiate_schedules

Этот код — **разовая рассылка метрик по email**.
Делает два SQL-запроса к базе:
- KKS vs QTY — проверяет расхождение количества позиций и кодов KKS
- EMPTY COUNTER — считает пустые ячейки по колонкам
Формирует Excel-файл с двумя листами и отправляет на почту с HTML-описанием.
Запускается один раз 27 ноября 2025 в 4:00 (ручной запуск через Airflow).

<br>

# leads

Этот код — **ежедневная синхронизация лидов AE**.
Забирает из AirTable таблицу "Лиды" (база "Таблица лидов"), фильтрует строки с пометкой RES/AE = 'AE', выгружает 12 полей (номер лида, этап, объект поставки, энергоблоки, тип, лот, оборудование, КБ, количество, цены и валюта).
Сортирует по номеру лида и загружает в Google Таблицу "Лиды AE".
Запускается каждый день в полночь.

<br>

# master_schedule

Этот код — **синхронизация расписаний из PostgreSQL в AirTable**.
Что делает:
- Берёт свежие данные из базы (за последние сутки) — расписания производства от заводов
- Создаёт недостающие колонки в AirTable автоматически (нормализует названия: нижний регистр, подчёркивания вместо пробелов)
- Связывает с проектами — находит соответствие между заводом/листом и проектом в таблице Projects
- Загружает/обновляет данные в AirTable (upsert по уникальному полю — комбинация завод+лист+позиция+KKS)
Запуск: только вручную (schedule_interval=None) — тяжёлая операция, нужна контроль.

<br>

# portal_PIT

Этот код — **еженедельное резервное копирование таблицы PIT из AirTable в PostgreSQL**.
Что делает:
- Забирает всю таблицу PIT из AirTable (Portal 2.0.4)
- Преобразует в JSON и сохраняет в PostgreSQL (таблица stage.portal_PIT) с timestamp
Зачем: история изменений, backup, аналитика.
Запуск: каждое воскресенье в полночь (0 0 * * 0).

<br>

# portal_projects

Этот код — **ежедневное резервное копирование таблицы Projects из AirTable в PostgreSQL**.
Что делает:
- Забирает всю таблицу Projects из AirTable (Portal 2.0.4)
- Преобразует в JSON и сохраняет в PostgreSQL (таблица stage.portal_projects) с timestamp
Зачем: история изменений проектов, backup, аналитика.
Запуск: каждый день в полночь (0 0 * * *).

<br>

# schedule_changes

Этот код — **автоматические уведомления о переносах сроков в графиках поставок**.
Что делает:
- Ищет изменения дат в таблице schedules_changes — где новая дата позже старой (перенос вправо)
- Группирует по ответственным менеджерам и проектам
- Формирует красивое HTML-письмо с таблицей изменений (проект → позиция → этап → старая дата → новая дата)
- Отправляет email каждому ответственному + копия руководству
Кому отправляет: 7 менеджеров (Исаев, Пухов, Шелудько, Горбулина, Пшенцова, Бойко) + обязательная копия Летягину, Мейендорфу, Сиваку, Исаеву.
Запуск: по будням каждые 2 часа с 6:30 до 15:30 (как и метрики ICP — видимо, связанные процессы).

<br>

# shifts

Этот код — **разовая загрузка истории переносов сроков в AirTable**.
Берёт из базы данных все изменения дат (не только переносы вправо, а любые изменения), преобразует в читаемый формат и загружает в таблицу "⏩Shifts" в AirTable (база Portal 2.0.3).
Поля: дата изменения, номер заказа, завод, позиция, количество, KKS, этап (EN/RU), дата до и после.
Запускается только вручную (CRON_EXP = None) — видимо, для миграции исторических данных или разового анализа.

<br>

# stage_delval, stage_dembla, stage_eho, stage_hawatubes, stage_jsons, stage_lc, stage_nirmal, stage_rkc

Этот код — **автоматическая загрузка графиков производства от завода**.
Что делает:
- Скачивает Excel-файлы с графиками от завода DelVal
- Парсит данные — значения ячеек и цвета (статусы)
- Обрабатывает — нормализует KKS-коды, добавляет номера строк
- Сохраняет в PostgreSQL — в таблицы stage.schedules_values (данные) и stage.schedules_colors (цвета/статусы) в формате JSON
Зачем: отслеживание сроков производства оборудования, анализ изменений, цветовая индикация статусов.
Запуск: по будням каждые 2 часа с 6:00 до 15:00 (6:00, 8:00, 10:00, 12:00, 14:00).
_Примечание_: Это один из семи аналогичных DAG'ов (DelVal, Dembla, HawaTubes, LC, RKC, Nirmal, EHO) — для каждого завода свой, отличается только MANUF_NAME.

<br>

# stage_kks_to_at

Этот код — **ежедневная синхронизация KKS-кодов из PostgreSQL в AirTable**.
Что делает:
- Берёт свежие данные из stage.schedules_values (за последние 3 дня) — распаковывает JSON, разбивает KKS по строкам
- Формирует уникальный ключ — комбинация завод+лист+позиция+KKS
- Загружает/обновляет в AirTable (таблица KKS_new, база Portal 2.0: Schedules DLC) — upsert по уникальному полю
Зачем: актуальный справочник KKS-кодов оборудования для аналитики и связывания данных.
Запуск: каждый день в полночь (0 0 * * *).

<br>

# stat_sheet_update

Этот код — **обновление статистики загрузки графиков в Google Таблицах**.
Что делает:
- Находит изменения в stage.schedules_values — когда содержимое графика отличается от предыдущей версии
- Фиксирует время последнего обновления по каждому заводу и листу
- Записывает в Google Таблицы — на лист "Stat" для 8 заводов (DelVal, Dembla, EHO, HawaTubes, LC, Nirmal, RKC, Jsons)
Зачем: контроль актуальности данных — видно, когда какой график последний раз обновлялся.
Запуск: по будням каждые 2 часа с 7:00 до 16:00 (7:00, 9:00, 11:00, 13:00, 15:00).

<br>

# working_tables

Этот код — **регулярное копирование проектов из Google Таблицы в PostgreSQL**.
Что делает:
- Читает таблицу "Проекты" из Google Sheets (17 колонок: проект, приоритет, заказчик, тип, объект поставки, договор, сроки, кураторы, цены и др.)
- Переименовывает колонки в английские названия
- Добавляет timestamp и загружает в PostgreSQL (таблица res_tables.working_tables)
Зачем: резервная копия рабочей таблицы проектов для аналитики и отчётности.
Запуск: по будням каждые 2 часа с 6:00 до 15:00 (6:00, 8:00, 10:00, 12:00, 14:00).
